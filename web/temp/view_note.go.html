<!DOCTYPE html>
<html lang="ru">
<head>
    {{template "head.go.html"}}
</head>
<body>
<div class="page">
    <div class="left-sidebar"></div>
    <div class="content">
        <div class="header">
            <h1 class="header-title">{{.note.Title}}</h1>
            <span class="header-meta">{{if .note.Author}}{{.note.Author}} ● {{end}}{{.note.CreatedAt.Format "January 02, 2006"}}</span>
        </div>

        <div id="editor">
            {{.content}}
        </div>
    </div>

    <div class="sidebar">
        {{if or .hasEdit .hasPass}}
            <button class="pub-btn" id="editBtn">Edit</button>
        {{end}}
    </div>
</div>

<div id="passwordModal" class="modal">
    <div class="modal-content">
        <p class="modal-title">Enter Password</p>
        <input type="password" id="notePassword" placeholder="Password">
        <button id="submitPassword">Edit Note</button>
    </div>
</div>
<script>
    new Quill('#editor', {
        readOnly: true,
        theme: 'bubble',
    });
</script>
{{if or .hasEdit .hasPass}}
<script>
    // Значения из бэкенда
    const hasEdit = {{.hasEdit}};
    const hasPass = {{.hasPass}};
    const noteID = "{{.note.ID}}";

    // Элементы
    const modal = document.getElementById("passwordModal");
    const passwordInput = document.getElementById("notePassword");
    const submitBtn = document.getElementById("submitPassword");
    const editBtn = document.getElementById("editBtn");

    // Клик по Edit
    editBtn.addEventListener("click", () => {
        if (hasEdit) {
            window.location.href = "/note/" + noteID + "/edit";
        } else if (hasPass) {
            modal.style.display = "block";
            passwordInput.focus();
        }
    });

    // Клик "Войти"
    submitBtn.addEventListener("click", () => {
        const password = passwordInput.value;
        fetch("/note/" + noteID + "/checkpass", {
            method: "POST",
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({password: password})
        })
            .then(res => res.json())
            .then(data => {
                if (data.ok) {
                    window.location.href = "/note/" + noteID + "/edit";
                } else {
                    alert("Неверный пароль");
                }
            });
    });

    // Обработка клавиш
    document.addEventListener("keydown", (e) => {
        if (modal.style.display === "block") {
            if (e.key === "Escape") {
                modal.style.display = "none";
            }
            if (e.key === "Enter" && document.activeElement === passwordInput) {
                submitBtn.click();
            }
        }
    });

    // Клик вне окна
    modal.addEventListener("click", (event) => {
        if (event.target === modal) {
            modal.style.display = "none";
            passwordInput.value = "";
        }
    });
</script>
{{end}}
</body>
</html>